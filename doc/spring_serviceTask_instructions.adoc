= BPM Service Tasks: spring_serviceTask

:numbered:

== Overview

image::images/springservicetask.png[]

Purpose of this example is to demonstrate use of a custom workItemHandler that leverages the Spring framework to persist a record in an application database. 
This approach should be avoided if possible. 
Instead, it is preferrable that business functions that leverages third-party libraries be encapsulated as a service (as per SOA) and invoked by a SOAP/REST/EJB service task. 
In some edge cases however, SOA may not be an option and thus this business functionality needs to run in the same thread of execution as the BPM process engine.
The application database selected for this reference architecture is:  postgresql.

== Config and Deployment:  Local Environment

=== local:  Clone this reference architecture

This reference architecture will be cloned both in your local computer as well as in your remote BPM Suite 6 Openshift environment.
To clone this reference architecture in your local environment, execute the following:

--------
git clone https://github.com/jboss-gpe-ref-archs/bpm_servicetasks.git
--------

Doing so will create a directory in your local computer called:  bpm_servicetasks.
For the purposes of this documentation, this directory will be referred to as $REF_ARCH_HOME.

=== local: Build the Reference Architecture
This reference architecture includes a _modules_ sub-project that needs to be built locally.
To build this _modules_ sub-project, execute the following:

. cd $REF_ARCH_HOME/modules
. mvn clean install -DskipTests

+
The end-result is a zip file that contains all the needed Spring framework libraries packaged as a JBoss Module in a new _gpe_ directory:

+
-----
$ jar -tf $REF_ARCH_HOME/modules/target/persistence.service.modules.zip
modules/
modules/README.txt
modules/system/
modules/system/layers/
modules/system/layers/gpe/
modules/system/layers/gpe/org/
modules/system/layers/gpe/org/spring/
modules/system/layers/gpe/org/spring/main/
modules/system/layers/gpe/org/spring/main/module.xml
modules/system/layers/gpe/org/spring/main/spring-context-3.2.3.RELEASE.jar
modules/system/layers/gpe/org/spring/main/spring-jdbc-3.2.3.RELEASE.jar
modules/system/layers/gpe/org/spring/main/spring-beans-3.2.3.RELEASE.jar
modules/system/layers/gpe/org/spring/main/spring-tx-3.2.3.RELEASE.jar
modules/system/layers/gpe/org/spring/main/spring-core-3.2.3.RELEASE.jar
-----

+
These Spring framework libraries are going to be added to the java classpath of your remote BPM Suite 6 runtime as JBoss modules.
Of note are the contents of:  modules/system/layers/gpe/org/spring/main/module.xml .
Notice that it defines a new JBoss Module called:  _org.spring_ .

. Secure copy this zip library to your remote BPM Suite 6 environment:

-----
scp $REF_ARCH_HOME/modules/target/persistence.service.modules.zip <ssh.url.to.your.bpm.environment>:/tmp
-----

=== BPM Suite 6: Deploy Spring framework JBoss module
The Spring libraries archived in a zip file and pushed to your BPM Suite 6 environment in the previous section now needs to be unzipped and made available as a new JBoss Module.

. ssh to your remote BPM Suite 6 environment
. cd $JBOSS_HOME
. unzip /tmp/persistence.service.modules.zip
. edit $JBOSS_HOME/modules/layers.conf and append the name _gpe_ to the list of _layers_ :

-----
layers=bpms,gpe
-----

=== local:  deploy the Spring workItemHandler
This reference architecture includes a Spring-based custom workItemHandler at:  $REF_ARCH_HOME/wih/src/main/java/com/redhat/gpe/refarch/bpm_servicetasks/processtier/SpringPersistenceWIH.java.
Execute the following in your local environment to make this Spring custom workItemHandler available for use in BPM Suite 6:

-----
cd $REF_ARCH_HOME/wih
mvn clean install -DskipTests
scp -r conf/modules/ jboss@docker_bpms:/opt/jboss_bpm_soa/jboss-eap-6.1
scp target/wih-1.0.jar jboss@docker_bpms:/opt/jboss_bpm_soa/jboss-eap-6.1/modules/system/layers/gpe/com/redhat/gpe/refarch/bpm_servicetasks/main/
-----

Collectively, the above commands build an artifact called: _wih-1.0.jar_ (which contains the SpringPersistenWIH class) and deploys it as a JBoss Module to the remote BPM Suite 6 runtime environment.
The above commands assume that your $JBOSS_HOME is at:  /opt/jboss_bpm_soa/jboss-eap-6.1 .
Modify these commands as appropriate for your environment.


=== BPM Suite 6: Define module dependency on Spring workItemHandler
Now that the  _org.spring_ and the _com.redhat.gpe.refarch.bpm_servicetasks_ JBoss Modules have been made available to JBoss EAP, the next step is to define an explicit dependency on these new modules to the BPM Suite 6 business-central web application.

. edit $JBOSS_HOME/standalone/deployments/business-central.war/WEB-INF/jboss-deployment-structure.xml
.. go to the bottom of the file and add a module dependency on the new _org.spring_ JBoss Module:

-----
<module name="org.yaml.snakeyaml" export="true" services="import" meta-inf="import"/>

<module name="com.redhat.gpe.refarch.bpm_servicetasks" export="true" services="import" meta-inf="import"/>

  </dependencies>
</deployment>
</jboss-deployment-structure>
-----

=== BPM Suite 6: Define Service Task mapping
This reference architecture includes a BPMN process definition called:  _spring_servicetask_.
This process definition includes a Service Task called: _SpringServiceTask_.
This name now needs to be mapped to our custom Spring-based workItemHandler.
Do this in the _CustomWorkItemHandlers.conf_ file of the business-central web archive:

. ssh into your remote BPM Suite 6 environment.
. edit:  $JBOSS_HOME/standalone/deployments/business-central.war/WEB-INF/classes/META-INF/CustomWorkItemHandlers.conf
. Add the following mapping:

-----
"SpringServiceTask": new com.redhat.gpe.refarch.bpm_servicetasks.wih.SpringPersistenceWIH(ksession)
-----

[start=2]
. Bounce your BPM Suite 6 java run-time.


=== App RDBMS: Allow for XA transactions

The BPM Suite 6 process engine writes its state to a relational database.
If using the BPM Openshift cartridge, the database used to support BPM Suite 6 is:  mysql.
The Spring custom work item handler included in this reference architecture, writes to an application database in the same JTA transaction used by the process engine.
Thus, when using this Spring custom work item handler, XA transactions are needed to support persisting to two different resources.
This section documents the configuration of postgresql to support XA transactions.
Modify these instructions as appropriate for your application database.

. (as postgres user) :  enable prepared transactions by uncommenting the following in ~/data/postgresql.conf

-----
max_prepared_transactions = 10 
-----

=== App RDBMS: Create database objects

The Spring custom work item handler included in this reference architecture, writes to a _customer_ table in a _test_ database.
This section documents the creation of these database objects using PostgreSQL.
Modify these instructions as appropriate for your application database.

. restart postgresql
. (as postgres user) : create user test with password 'test';
. (as postgres user) : createdb -O test test
. (as postgres user) : psql test

-----
test=# create table customer(id int8 not null, firstname varchar(255), lastname varchar(255), primary key (id));
test=# create sequence customerId;
test=# grant all privileges on table customer to test;
test=# grant all privileges on sequence customerId to test;
-----

=== BPM Suite 6: Add XA datasource to JBoss EAP 6
The Spring custom work item handler executes a JNDI lookup for a datasource pool called:  _test-cp-xa_.
Subsequently, a new datasource with this name should be configured in JBoss EAP.
The following example is postgresql specific.
Modify as needed for your application database.

-----
                <xa-datasource jndi-name="java:jboss/datasources/test-cp-xa" pool-name="test-cp-xa" enabled="true">
                    <xa-datasource-property name="ServerName">
                        172.9.4.3
                    </xa-datasource-property>
                    <xa-datasource-property name="DatabaseName">
                        test
                    </xa-datasource-property>
                    <xa-datasource-class>org.postgresql.xa.PGXADataSource</xa-datasource-class>
                    <driver>postgresql</driver>
                    <new-connection-sql>select 1;</new-connection-sql>
                    <xa-pool>
                        <min-pool-size>1</min-pool-size>
                        <max-pool-size>5</max-pool-size>
                    </xa-pool>
                    <security>
                        <user-name>test</user-name>
                        <password>test</password>
                    </security>
                </xa-datasource>

-----
 
=== BPM Suite 6: Clone this reference architecture
This reference architecture includes a KIE project called: _processTier_ .
The _processTier_ project includes several BPMN2 process definitions that show-case invocation of remote SOA services via standard transports.

Use the following steps to clone this reference architecture in BPM Suite 6:

. Log into the Business-Central web application of BPM Suite 6
. navigate to:  Authoring -> Administration.
. Select `Organizational Units` -> `Manage Organizational Units`
. Under `Organizational Unit Manager`, select the `Add` button
. Enter a name of _gpe_ and an owner of _jboss_. Click `OK`
. Clone this fsw_bpms_integration repository in BPM Suite 6
.. Select `Repositories` -> `Clone Repository` .
.. Populate the _Clone Repository_ box as follows and then click _Clone_ :

image::images/clone_repo.png[]

Enter _bpmservicetask_ as the value of the _repository name_.
The value of _Git URL_ is the URL to this reference architecture in github:

-----
https://github.com/jboss-gpe-ref-archs/bpm_servicetask.git
-----

Once successfully cloned, BPM Suite 6 will pop-up a new dialog box with the message:  _The repository is cloned successfully_


=== BPM Suite 6:  Build and Deploy _processTier_ project
. Build and Deploy the _processTier_ project by executing the following:
.. Authoring -> Project Authoring -> Tools -> Project Editor -> Build and Deploy
. If interested, verify deployment:
.. Deploy -> Deployments

== Manual Testing
This reference architecture includes a BPMN2 called: _spring_servicetask.bpmn2_.
It can be executed manually as follows:

. Navigate to:  Process Management -> Process Definitions
. Select the _Start_ icon of any of the _spring_servicetask.bpmn2_ process definition.
. A form should appear with only a _play_ button to start that specific process.
. Make sure your $JBOSS_HOME/standalone/log/server.log is being tailed and click this play button.

=== RESULTS:  spring_servicetask
The _customer_ table of your application database should now include a record as follows:

-----
bash-4.2$ psql test
psql (9.2.7)
Type "help" for help.

test=# select * from customer;
 id |   firstname   | lastname 
----+---------------+----------
  0 | Azra and Alex | Bride
(1 row)
-----

You now have configured and tested a custom workItemHandler that leverages the Spring framework to persist to an application database.

